<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FFXIV - Pose Image Embedder for Brio</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='advanced.js') }}"></script>
    {% include "open-graph-meta-tags.html" %}
</head>
<body data-theme="dark">  <!-- Dark mode default -->

<div class="theme-toggle">
    <label class="switch">
        <input type="checkbox" id="themeSwitch">
        <span class="slider"></span>
    </label>
    <span class="theme-label">Dark Mode</span>
</div>

<div class="container">
    {% include "container-header.html" %}

    <form id="mainForm" action="/process" method="post" enctype="multipart/form-data" class="card">

        <!-- Insert example image preview (centered, responsive) -->
        <div class="form-image-preview" aria-hidden="true">
            <img src="{{ url_for('static', filename='example.png') }}" alt="Example" class="example-img">
        </div>

        <!-- Simple / Advanced toggle -->
        <div class="toggle-row">
            <a class="green-btn mode-toggle-adv" href="/advanced">Advanced Editor</a>
        </div>

        <h2>Image Source</h2>

        <label>Image URL</label>
        <div class="input-row">
            <input id="imageUrlInput" type="text" name="image_url" placeholder="https://example.com/image.png">
            <button type="button" id="clearImageUrlBtn" class="clear-btn" aria-label="Clear image URL">Clear</button>
        </div>

        <label>Or upload image</label>
        <div class="file-row">
            <input id="imageFileInput" type="file" name="image_file" accept="image/*">
            <button type="button" id="clearImageBtn" class="clear-btn" aria-label="Clear image file">Clear</button>
        </div>

        {% include "form-image-resizer.html" %}

        <h2>Pose File</h2>

        <label>Pose File URL</label>
        <div class="input-row">
            <input id="poseUrlInput" type="text" name="pose_url" placeholder="https://example.com/file.pose">
            <button type="button" id="clearPoseUrlBtn" class="clear-btn" aria-label="Clear pose URL">Clear</button>
        </div>

        <label>Or upload .pose file</label>
        <div class="file-row">
            <input id="poseFileInput" type="file" name="pose_file" accept=".pose,application/json">
            <button type="button" id="clearPoseBtn" class="clear-btn" aria-label="Clear pose file">Clear</button>
        </div>

        <p class="note">Max pose file size: 10 MB</p>

        <button type="submit">Merge & Download</button>

        {% include "container-footer.html" %}

    </form>
    <div class="center">
        <p class="subtitle">Made by Tex Nevada - {{ version }}</p>
    </div>
</div>

{% include "theme-selector.html" %}

<!-- New JS: file input clear buttons and AJAX form submit to handle download and clearing inputs -->
<script>
    (function(){
        const form = document.getElementById('mainForm');
        const imageInput = document.getElementById('imageFileInput');
        const poseInput = document.getElementById('poseFileInput');
        const clearImageBtn = document.getElementById('clearImageBtn');
        const clearPoseBtn = document.getElementById('clearPoseBtn');
        const imageUrlInput = document.getElementById('imageUrlInput');
        const poseUrlInput = document.getElementById('poseUrlInput');
        const clearImageUrlBtn = document.getElementById('clearImageUrlBtn');
        const clearPoseUrlBtn = document.getElementById('clearPoseUrlBtn');
        const submitBtn = form.querySelector('button[type="submit"]');

        // Inline error container (insert once)
        let inlineError = document.createElement('div');
        inlineError.className = 'inline-error';
        inlineError.style.display = 'none';
        form.insertBefore(inlineError, submitBtn);

        function updateClearBtn(input, btn){
            if(!input || !btn) return;
            let hasValue = false;
            if(input.type === 'file'){
                hasValue = input.files && input.files.length;
            } else {
                hasValue = !!(input.value && input.value.trim().length);
            }
            btn.style.display = hasValue ? 'inline-block' : 'none';
        }

        function clearValidationStates(){
            [imageInput, poseInput, imageUrlInput, poseUrlInput].forEach(el=>{ if(!el) return; el.classList.remove('invalid-field'); });
            inlineError.style.display = 'none';
            inlineError.textContent = '';
        }

        function applyInvalid(el){
            if(!el) return;
            el.classList.add('invalid-field');
        }

        if(imageInput){
            imageInput.addEventListener('change', ()=> { updateClearBtn(imageInput, clearImageBtn); clearValidationStates(); });
            clearImageBtn.addEventListener('click', ()=>{ imageInput.value = ''; updateClearBtn(imageInput, clearImageBtn); });
            updateClearBtn(imageInput, clearImageBtn);
        }

        if(poseInput){
            poseInput.addEventListener('change', ()=> { updateClearBtn(poseInput, clearPoseBtn); clearValidationStates(); });
            clearPoseBtn.addEventListener('click', ()=>{ poseInput.value = ''; updateClearBtn(poseInput, clearPoseBtn); });
            updateClearBtn(poseInput, clearPoseBtn);
        }

        // URL input clear button handlers
        if(imageUrlInput){
            imageUrlInput.addEventListener('input', ()=> { updateClearBtn(imageUrlInput, clearImageUrlBtn); clearValidationStates(); });
            clearImageUrlBtn.addEventListener('click', ()=>{ imageUrlInput.value = ''; updateClearBtn(imageUrlInput, clearImageUrlBtn); });
            updateClearBtn(imageUrlInput, clearImageUrlBtn);
        }

        if(poseUrlInput){
            poseUrlInput.addEventListener('input', ()=> { updateClearBtn(poseUrlInput, clearPoseUrlBtn); clearValidationStates(); });
            clearPoseUrlBtn.addEventListener('click', ()=>{ poseUrlInput.value = ''; updateClearBtn(poseUrlInput, clearPoseUrlBtn); });
            updateClearBtn(poseUrlInput, clearPoseUrlBtn);
        }

        // Helper to check whether an image source is provided
        function hasImageSource(){
            const hasFile = imageInput && imageInput.files && imageInput.files.length;
            const hasUrl = imageUrlInput && imageUrlInput.value && imageUrlInput.value.trim().length;
            return !!(hasFile || hasUrl);
        }
        // Helper to check whether a pose source is provided
        function hasPoseSource(){
            const hasFile = poseInput && poseInput.files && poseInput.files.length;
            const hasUrl = poseUrlInput && poseUrlInput.value && poseUrlInput.value.trim().length;
            return !!(hasFile || hasUrl);
        }

        // Submit via fetch so we can trigger download and then clear file inputs reliably
         form.addEventListener('submit', async (e)=>{
             e.preventDefault();
             clearValidationStates();

             // Client-side presence validation: require at least one image source and one pose source
             let firstInvalid = null;
             if(!hasImageSource()){
                 // Mark both URL and file inputs as invalid so user sees where to act
                 applyInvalid(imageUrlInput);
                 applyInvalid(imageInput);
                 if(!firstInvalid) firstInvalid = imageUrlInput || imageInput;
             }
             if(!hasPoseSource()){
                 applyInvalid(poseUrlInput);
                 applyInvalid(poseInput);
                 if(!firstInvalid) firstInvalid = poseUrlInput || poseInput;
             }

             if(firstInvalid){
                 inlineError.textContent = 'Please provide both an image (URL or file) and a .pose file (URL or upload) before merging.';
                 inlineError.style.display = 'block';
                 if(firstInvalid && typeof firstInvalid.focus === 'function') firstInvalid.focus();
                 return;
             }

             submitBtn.disabled = true;

             const MAX_TOTAL_BYTES = 10 * 1024 * 1024;
             // Calculate combined size of uploaded files (pose + image) when present
             let totalBytes = 0;
             if(poseInput && poseInput.files && poseInput.files.length){ totalBytes += poseInput.files[0].size; }
             if(imageInput && imageInput.files && imageInput.files.length){ totalBytes += imageInput.files[0].size; }
             if(totalBytes > MAX_TOTAL_BYTES){
                 alert('Error: Combined upload (pose + image) exceeds 10 MB');
                 submitBtn.disabled = false;
                 return;
             }

             const fd = new FormData(form);
             try{
                 const resp = await fetch(form.action, { method: 'POST', body: fd });
                 if(!resp.ok){
                     const txt = await resp.text();
                     alert('Error: ' + txt);
                     return;
                 }
                 const blob = await resp.blob();
                 // Determine filename from Content-Disposition header if present
                 let filename = 'download.pose';
                 const cd = resp.headers.get('Content-Disposition') || '';
                 const m = cd.match(/filename\*=UTF-8''([^;\n\r]+)|filename="?([^";]+)"?/);
                 if(m){
                     filename = decodeURIComponent(m[1] || m[2]);
                 }
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = filename;
                 document.body.appendChild(a);
                 a.click();
                 a.remove();
                 URL.revokeObjectURL(url);

                 // Clear file inputs after successful download
                 if(imageInput){ imageInput.value = ''; updateClearBtn(imageInput, clearImageBtn); }
                 if(poseInput){ poseInput.value = ''; updateClearBtn(poseInput, clearPoseBtn); }
                 // Clear URL inputs as well
                 if(imageUrlInput){ imageUrlInput.value = ''; updateClearBtn(imageUrlInput, clearImageUrlBtn); }
                 if(poseUrlInput){ poseUrlInput.value = ''; updateClearBtn(poseUrlInput, clearPoseUrlBtn); }
             }catch(err){
                 alert('Upload failed: ' + err);
             }finally{
                 submitBtn.disabled = false;
             }
         });
    })();
</script>
</body>
</html>
