<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FFXIV - Pose Image Embedder for Brio</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='advanced.js') }}"></script>
</head>
<body data-theme="dark">  <!-- Dark mode default -->

<div class="theme-toggle">
    <label class="switch">
        <input type="checkbox" id="themeSwitch">
        <span class="slider"></span>
    </label>
    <span class="theme-label">Dark Mode</span>
</div>

<div class="container">
    {% include "container-header.html" %}

    <form id="mainForm" action="/process" method="post" enctype="multipart/form-data" class="card">

        <!-- Insert example image preview (centered, responsive) -->
        <div class="form-image-preview" aria-hidden="true">
            <img src="{{ url_for('static', filename='example.png') }}" alt="Example" class="example-img">
        </div>

        <!-- Simple / Advanced toggle -->
        <div class="toggle-row">
            <a class="green-btn mode-toggle-adv" href="/advanced">Advanced Editor</a>
        </div>

        <h2>Image Source</h2>

        <label>Image URL</label>
        <div class="input-row">
            <input id="imageUrlInput" type="text" name="image_url" placeholder="https://example.com/image.png">
            <button type="button" id="clearImageUrlBtn" class="clear-btn" aria-label="Clear image URL">Clear</button>
        </div>

        <label>Or upload image</label>
        <div class="file-row">
            <input id="imageFileInput" type="file" name="image_file" accept="image/*">
            <button type="button" id="clearImageBtn" class="clear-btn" aria-label="Clear image file">Clear</button>
        </div>

        {% include "form-image-resizer.html" %}

        <h2>Pose File</h2>

        <label>Pose File URL</label>
        <div class="input-row">
            <input id="poseUrlInput" type="text" name="pose_url" placeholder="https://example.com/file.pose">
            <button type="button" id="clearPoseUrlBtn" class="clear-btn" aria-label="Clear pose URL">Clear</button>
        </div>

        <label>Or upload .pose file</label>
        <div class="file-row">
            <input id="poseFileInput" type="file" name="pose_file" accept=".pose,application/json">
            <button type="button" id="clearPoseBtn" class="clear-btn" aria-label="Clear pose file">Clear</button>
        </div>

        <p class="note">Max pose file size: 100 MB</p>

        <button type="submit">Merge & Download</button>

        {% include "container-footer.html" %}

    </form>
    <div class="center">
        <p class="subtitle">Made by Tex Nevada - {{ version }}</p>
    </div>
</div>

<script>
    const switchEl = document.getElementById("themeSwitch");
    const body = document.body;

    // Default dark mode
    switchEl.checked = true;

    switchEl.addEventListener("change", () => {
        if (switchEl.checked) {
            body.setAttribute("data-theme", "dark");
            document.querySelector(".theme-label").innerText = "Dark Mode";
        } else {
            body.setAttribute("data-theme", "light");
            document.querySelector(".theme-label").innerText = "Light Mode";
        }
    });
</script>

<!-- New JS: file input clear buttons and AJAX form submit to handle download and clearing inputs -->
<script>
    (function(){
        const form = document.getElementById('mainForm');
        const imageInput = document.getElementById('imageFileInput');
        const poseInput = document.getElementById('poseFileInput');
        const clearImageBtn = document.getElementById('clearImageBtn');
        const clearPoseBtn = document.getElementById('clearPoseBtn');
        const imageUrlInput = document.getElementById('imageUrlInput');
        const poseUrlInput = document.getElementById('poseUrlInput');
        const clearImageUrlBtn = document.getElementById('clearImageUrlBtn');
        const clearPoseUrlBtn = document.getElementById('clearPoseUrlBtn');
        const submitBtn = form.querySelector('button[type="submit"]');

        function updateClearBtn(input, btn){
            if(!input || !btn) return;
            let hasValue = false;
            if(input.type === 'file'){
                hasValue = input.files && input.files.length;
            } else {
                hasValue = !!(input.value && input.value.trim().length);
            }
            btn.style.display = hasValue ? 'inline-block' : 'none';
        }

        if(imageInput){
            imageInput.addEventListener('change', ()=> updateClearBtn(imageInput, clearImageBtn));
            clearImageBtn.addEventListener('click', ()=>{ imageInput.value = ''; updateClearBtn(imageInput, clearImageBtn); });
            updateClearBtn(imageInput, clearImageBtn);
        }

        if(poseInput){
            poseInput.addEventListener('change', ()=> updateClearBtn(poseInput, clearPoseBtn));
            clearPoseBtn.addEventListener('click', ()=>{ poseInput.value = ''; updateClearBtn(poseInput, clearPoseBtn); });
            updateClearBtn(poseInput, clearPoseBtn);
        }

        // URL input clear button handlers
        if(imageUrlInput){
            imageUrlInput.addEventListener('input', ()=> updateClearBtn(imageUrlInput, clearImageUrlBtn));
            clearImageUrlBtn.addEventListener('click', ()=>{ imageUrlInput.value = ''; updateClearBtn(imageUrlInput, clearImageUrlBtn); });
            updateClearBtn(imageUrlInput, clearImageUrlBtn);
        }

        if(poseUrlInput){
            poseUrlInput.addEventListener('input', ()=> updateClearBtn(poseUrlInput, clearPoseUrlBtn));
            clearPoseUrlBtn.addEventListener('click', ()=>{ poseUrlInput.value = ''; updateClearBtn(poseUrlInput, clearPoseUrlBtn); });
            updateClearBtn(poseUrlInput, clearPoseUrlBtn);
        }

        // Submit via fetch so we can trigger download and then clear file inputs reliably
         form.addEventListener('submit', async (e)=>{
             e.preventDefault();
             submitBtn.disabled = true;

             // Enforce client-side pose file size <= 100MB if a file is selected
-            const MAX_POSE_BYTES = 100 * 1024 * 1024;
-            if(poseInput && poseInput.files && poseInput.files.length){
-                const f = poseInput.files[0];
-                if(f.size > MAX_POSE_BYTES){
-                    alert('Error: Pose file exceeds 100 MB');
-                    submitBtn.disabled = false;
-                    return;
-                }
-            }
+            const MAX_TOTAL_BYTES = 100 * 1024 * 1024;
+            // Calculate combined size of uploaded files (pose + image) when present
+            let totalBytes = 0;
+            if(poseInput && poseInput.files && poseInput.files.length){ totalBytes += poseInput.files[0].size; }
+            if(imageInput && imageInput.files && imageInput.files.length){ totalBytes += imageInput.files[0].size; }
+            if(totalBytes > MAX_TOTAL_BYTES){
+                alert('Error: Combined upload (pose + image) exceeds 100 MB');
+                submitBtn.disabled = false;
+                return;
+            }

             const fd = new FormData(form);
             try{
                 const resp = await fetch(form.action, { method: 'POST', body: fd });
                 if(!resp.ok){
                     const txt = await resp.text();
                     alert('Error: ' + txt);
                     return;
                 }
                 const blob = await resp.blob();
                 // Determine filename from Content-Disposition header if present
                 let filename = 'download.pose';
                 const cd = resp.headers.get('Content-Disposition') || '';
                 const m = cd.match(/filename\*=UTF-8''([^;\n\r]+)|filename="?([^";]+)"?/);
                 if(m){
                     filename = decodeURIComponent(m[1] || m[2]);
                 }
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = filename;
                 document.body.appendChild(a);
                 a.click();
                 a.remove();
                 URL.revokeObjectURL(url);

                 // Clear file inputs after successful download
                 if(imageInput){ imageInput.value = ''; updateClearBtn(imageInput, clearImageBtn); }
                 if(poseInput){ poseInput.value = ''; updateClearBtn(poseInput, clearPoseBtn); }
                 // Clear URL inputs as well
                 if(imageUrlInput){ imageUrlInput.value = ''; updateClearBtn(imageUrlInput, clearImageUrlBtn); }
                 if(poseUrlInput){ poseUrlInput.value = ''; updateClearBtn(poseUrlInput, clearPoseUrlBtn); }
             }catch(err){
                 alert('Upload failed: ' + err);
             }finally{
                 submitBtn.disabled = false;
             }
         });
    })();
</script>
</body>
</html>
